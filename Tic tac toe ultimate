#include <iostream>
#include <windows.h>
#include <ctime>
using namespace std;
HANDLE hout =GetStdHandle(STD_OUTPUT_HANDLE);
HANDLE hin  =GetStdHandle(STD_INPUT_HANDLE);
INPUT_RECORD InputRecord;DWORD Events;
void gotoxy(int x,int y);
void color(int x);
int main()
{
    int t[3][3][3][3],a[3][3],x,y,X,Y,i,j,x1,y1,mo;
    int v,lx0,lx,ly0,ly,w,k,q,s,g=0,p1=0,p2=0,p=0;
    char c;bool d;
    cout<<"1 for players 2 for computers";
    cin>>mo;
    RET:
    for(i=0;i<3;i++)
        for(j=0;j<3;j++)
        {
            a[i][j]=0;
            for(k=0;k<3;k++)
                for(q=0;q<3;q++)
                    t[i][j][k][q]=0;
        }
    v=1;lx0=0;lx=16;ly0=0;ly=16;w=0;
    c='X';d=true;
    gotoxy(0,0);
    for(i=0;i<40;i++)
        cout<<"                                             ";
    gotoxy(0,0);
    srand((int)time(0));
    for(i=0;i<17;i++)
    {
        if(i%2==0)
        {
            color(7);cout<<" | | ";
            color(15);cout<<'|';
            color(7);cout<<" | | ";
            color(15);cout<<'|';
            color(7);cout<<" | |\n";
        }
        else
            if(i==5||i==11)
            {
                color(15);
                cout<<"-----+-----+-----\n";
            }
            else
            {
                color(7);cout<<"-+-+-";
                color(15);cout<<'|';
                color(7);cout<<"-+-+-";
                color(15);cout<<'|';
                color(7);cout<<"-+-+-\n";
            }
    }
    while(w<81)
    {
        gotoxy(0,17);color(15);
        cout<<"X:"<<p1<<" O:"<<p2<<" Ties:"<<p;
        cout<<"\nGames:"<<g;
        IMP:
        if(mo==1)
        {
            while(!GetAsyncKeyState(VK_LBUTTON))
            {
                if(GetAsyncKeyState(VK_CONTROL))
                {
                    p1^=p2^=p1^=p2;
                    Sleep(100);
                }
                ReadConsoleInput(hin,&InputRecord,1,&Events);
                x=InputRecord.Event.MouseEvent.dwMousePosition.X;
                y=InputRecord.Event.MouseEvent.dwMousePosition.Y;
            }
            Sleep(200);
        }
        if(GetAsyncKeyState(VK_ESCAPE))
            Sleep(1000);
        if(mo==2)
        {
            x=rand()%(lx-lx0+1)+lx0;
            y=rand()%(ly-ly0+1)+ly0;
        }
        x1=x;y1=y;x/=2;y/=2;
        while(x>=3)x-=3;
        while(y>=3)y-=3;
        if(d==true)
        {
            if(x1/2<3)X=0;else
                if(x1/2>5)X=2;
                else X=1;
            if(y1/2<3)Y=0;else
                if(y1/2>5)Y=2;
                else Y=1;
        }
        if(t[Y][X][y][x]!=0||(x1>lx||x1<lx0||y1>ly||y1<ly0)||x1%2!=0||y1%2!=0)
            goto IMP;
        gotoxy(x1,y1);
        if(c=='X')
            color(12);
        else
            color(10);
        cout<<c;
        t[Y][X][y][x]=v;
        k=0;q=0;
        for(i=0; i<3; i++)
        {
            if(t[Y][X][i][x]==v)k++;
            if(t[Y][X][y][i]==v)q++;
        }
        if(k!=3&&q!=3)
        {
            k=0;q=0;s=x+y;
            if(s%2==0)
            {
                for(i=2,j=0; j<3; j++,i--)
                    if(t[Y][X][i][j]==v)k++;
                for(i=0,j=0; j<3; j++,i++)
                    if(t[Y][X][i][j]==v)q++;
            }
        }for(i=0,j=0;i<3;i++)
        {
            if(t[Y][X][0][i]!=0)j++;
            if(t[Y][X][1][i]!=0)j++;
            if(t[Y][X][2][i]!=0)j++;
        }
        if(j==3)
            a[Y][X]=3;
        w++;if(q>2||k>2)
        {
            a[Y][X]=v;
            for(i=0;i<3;i++)
                for(j=0;j<3;j++)
                {
                    gotoxy((j+3*X)*2,(i+3*Y)*2);
                    if(c=='X')
                        SetConsoleTextAttribute(hout,12);
                    else
                        SetConsoleTextAttribute(hout,10);
                    if(t[Y][X][i][j]==0)
                    {
                        w++;
                        t[Y][X][i][j]=v;
                    }
                    cout<<c;
                }
            k=0;q=0;
            for(i=0; i<3; i++)
            {
                if(a[i][X]==v)k++;
                if(a[Y][i]==v)q++;
            }
            if(k!=3&&q!=3)
            {
                k=0;q=0;s=X+Y;
                if(s%2==0)
                {
                    for(i=2,j=0; j<3; j++,i--)
                        if(a[i][j]==v)k++;
                    for(i=0,j=0; j<3; j++,i++)
                        if(a[i][j]==v)q++;
                }
            }
            if(q>2||k>2)w=81;
        }
        if(c=='X'){c='O';v=2;}
        else{c='X';v=1;}
        if(a[y][x]!=0)
            d=true;
        else d=false;
        X=x;Y=y;
        if(d==false)
        {
            if(x==0){lx0=0;lx=5;}    if(y==0){ly0=0;ly=5;}
            if(x==1){lx0=5;lx=11;}   if(y==1){ly0=5;ly=11;}
            if(x==2){lx0=11;lx=16;}  if(y==2){ly0=11;ly=16;}
        }else
        {
            lx0=0;lx=16;ly0=0;ly=16;
        }
    }
    gotoxy(0,18);
    color(15);
    if(k==3||q==3)
    {
        if(c=='X')
        {
            cout<<"O Wins!";
            p2++;
        }
        else
        {
            cout<<"X Wins!";
            p1++;
        }
    }else
    {
        cout<<"Its a tie";
        p++;
    }
    g++;
    goto RET;
}
void gotoxy(int x,int y)
{
    COORD coord;
    coord.X=x;
    coord.Y=y;
    SetConsoleCursorPosition(hout,coord);
}
void color(int x)
{
    SetConsoleTextAttribute(hout,x);
}
